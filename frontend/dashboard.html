<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Edu2Job - Dashboard</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: #f4f6f9; display: flex; height: 100vh; } 
        .sidebar { width: 250px; background: #343a40; color: white; display: flex; flex-direction: column; padding-top: 20px; transition: 0.3s; } 
        .logo { color: #4f46e5; font-size: 26px; font-weight: 700; text-align: center; margin-bottom: 40px; } 
        .menu-item { padding: 15px 25px; cursor: pointer; color: #adb5bd; display: flex; align-items: center; gap: 15px; text-decoration: none; font-size: 14px; border-left: 4px solid transparent; transition: 0.2s; } 
        .menu-item:hover { background: #495057; color: white; }  
        .menu-item.active { background: #495057; color: #4f46e5; border-left: 4px solid #4f46e5; font-weight: 600; } 
        .main { flex: 1; padding: 30px 50px; overflow-y: auto; } 
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; color: #333; } 
        .content-section { display: none; animation: fadeIn 0.3s ease-in-out; } 
        .content-section.active { display: block; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .row { display: flex; gap: 20px; margin-bottom: 20px; } 
        .col-8 { flex: 2; } 
        .col-4 { flex: 1; } 
        .card { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eaeaea; margin-bottom: 20px; } 
        .card-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; } 
        .profile-grid { display: grid; grid-template-columns: 160px 1fr; gap: 12px; font-size: 14px; align-items: center; } 
        .label { color: #555; font-weight: 500; } 
        .value { color: #333; font-weight: 400; } 
        .btn { display: block; width: 100%; padding: 12px; border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer; text-align: center; font-size: 14px; transition: 0.2s; } 
        .btn-blue { background-color: #4f46e5; } .btn-blue:hover { background-color: #4338ca; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); } 
        .modal-box.login-theme { background: #ffffff; padding: 40px; border-radius: 16px; width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .modal-box h3 { color: #4f46e5; font-size: 24px; font-weight: 700; margin-top: 0; margin-bottom: 20px; text-align: center; }
        .login-input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 500; }
        .login-input { width: 100%; padding: 12px; border: 1px solid #e1e1e1; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box; font-family: 'Poppins', sans-serif; transition: 0.2s; }
        .login-input:focus { border-color: #4f46e5; }
        .login-tag-container { border: 1px solid #e1e1e1; border-radius: 8px; padding: 8px; display: flex; flex-wrap: wrap; gap: 8px; min-height: 45px; }
        .login-tag { background-color: #eef2ff; color: #4f46e5; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .login-tag i { cursor: pointer; font-size: 10px; }
        .btn-primary-login { width: 100%; padding: 12px; background-color: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary-login:disabled { background-color: #a5a5a5; cursor: not-allowed; }
        .btn-secondary-login { background: white; color: #555; border: 1px solid #ddd; border-radius: 8px; padding: 10px 20px; cursor: pointer; margin-left: 10px; }
        .star-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #ccc; padding: 0 2px; }
        .star-btn:hover { color: #f59e0b; }
        .password-wrapper { position: relative; width: 100%; }
        .password-wrapper input { padding-right: 40px; }
        .toggle-password { position: absolute; top: 38%; right: 10px; transform: translateY(-50%); cursor: pointer; color: #888; }
    </style> 
</head> 
<body> 
    <div class="sidebar"> 
        <div class="logo">Edu2Job</div> 
        <a class="menu-item active" id="menu-dashboard" onclick="switchTab('dashboard')"><i class="fas fa-th-large"></i> Dashboard</a> 
        <a class="menu-item" id="menu-profile" onclick="switchTab('profile')"><i class="fas fa-user-circle"></i> My Profile</a> 
        <a class="menu-item" id="menu-history" onclick="switchTab('history'); loadHistory()"><i class="fas fa-history"></i> Prediction History</a> 
        <div id="adminLinkContainer"></div>
        <a onclick="logout()" class="menu-item"><i class="fas fa-sign-out-alt"></i> Logout</a> 
    </div> 

    <div class="main"> 
        <div class="header">
            <div>
                <h2 style="margin:0;">Dashboard</h2>
                <span id="welcomeMsg" style="color:#666; font-size:14px;">Welcome Back</span> 
            </div>
        </div> 

        <div id="dashboardSection" class="content-section active"> 
            <div class="row"> 
                <div class="col-8"> 
                    <div class="card" style="background: linear-gradient(135deg, #fff 70%, #f0f4ff 100%);"> 
                        <div class="card-title">Latest Prediction Result</div> 
                        <div id="latestResultContainer">
                            <p style="color: #666; font-style: italic;">
                                No predictions yet. <span style="cursor:pointer; color:#4f46e5; font-weight:600;" onclick="openProfileModal()">Predict now.</span>
                            </p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Trending Jobs</div>
                        <div style="height: 275px;"><canvas id="trendsChart"></canvas></div>
                    </div>
                </div> 
                <div class="col-4"> 
                    <div class="card">
                        <div class="card-title">Education Impact</div>
                        <div style="height: 450px;"><canvas id="degreeChart"></canvas></div>
                        <p style="text-align:center; font-size:12px; color:#666; margin-top:10px;">Degree based predicted students count</p>
                    </div>
                </div> 
            </div> 
        </div> 

        <div id="profileSection" class="content-section"> 
            <div class="row"> 
                <div class="col-8"> 
                    <div class="card"> 
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>My Academic Profile</span>
                            <button class="btn btn-blue" style="width: auto; margin:0;" onclick="openProfileModal()">
                                <i class="fas fa-pen"></i> Edit & Predict
                            </button>
                        </div>
                        <div class="profile-grid"> 
                            <div class="label">Name:</div> <div class="value" id="dispName">Loading...</div> 
                            <div class="label">Email:</div> <div class="value" id="dispEmail">Loading...</div> 
                            <div class="label">Degree:</div> <div class="value" id="dispDegree">-</div> 
                            <div class="label">Specialization:</div> <div class="value" id="dispSpec">-</div>
                            <div class="label">Graduation Year:</div> <div class="value" id="dispYear">-</div>
                            <div class="label">CGPA:</div> <div class="value" id="dispCgpa">-</div> 
                            <div class="label">Internships:</div> <div class="value" id="dispIntern">-</div> 
                            <div class="label">Certifications:</div> <div class="value" id="dispCert">-</div> 
                            <div class="label">Skills:</div> <div class="value" id="dispSkills">-</div> 
                        </div> 
                    </div> 
                    <div class="card" style="margin-top:20px;">
                        <div class="card-title">Market Benchmark</div>
                        <div style="height: 250px;"><canvas id="comparisonChart"></canvas></div>
                        <div id="insightsContainer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;"></div>
                    </div>
                </div> 
                <div class="col-4"> 
                    <div class="card"> 
                        <div class="card-title">Account Security</div>
                        <button class="btn btn-blue" style="margin:0;" onclick="openPassModal()"><i class="fas fa-key"></i> Change password</button>
                    </div> 
                </div> 
            </div>
        </div>          
        
        <div id="historySection" class="content-section"> 
            <div class="card">
                <div class="card-title">
                    Prediction History 
                    <button onclick="loadHistory()" style= "float: right;  padding: 5px 15px; border:none; border-radius: 4px; cursor: pointer; color: white; background: #4299e1; font-size:12px;"><i class="fas fa-sync"></i> Refresh</button>
                </div> 
                <div id="historyList"><p style="color:#666">Loading history...</p></div>
            </div> 
        </div> 
    </div>

    <div class="modal" id="profileModal"> 
        <div class="modal-box login-theme"> 
            <h3>Update & Predict</h3> 
            
            <div class="login-input-group">
                <label>Full Name</label>
                <input type="text" class="login-input" id="editName" readonly style="background:#f9f9f9; color:#999;">
            </div>
            <br>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="login-input-group">
                    <label>Degree</label>
                    <select id="editDegree" class="login-input" onchange="updateSpecializations()"></select>
                </div>
                <div class="login-input-group">
                    <label>Specialization</label>
                    <select id="editSpec" class="login-input" onchange="updateCertSuggestions()"></select>
                </div>
            </div>
            <br>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="login-input-group">
                    <label>Graduation Year</label>
                    <select id="editYear" class="login-input"></select>
                </div>
                <div class="login-input-group">
                    <label>CGPA (0-10)</label>
                    <input type="number" step="0.1" id="editCgpa" class="login-input" min="0" max="10" placeholder="8.5">
                </div>
            </div>
            <br>
            
            <div class="login-input-group">
                <label>Internships</label>
                <select id="editIntern" class="login-input">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <br>

            <div class="login-input-group">
                <label>Certifications</label>
                <input list="certOptions" id="editCert" class="login-input" placeholder="Type or Select">
                <datalist id="certOptions"></datalist>
            </div>
            <br>

            <div class="login-input-group">
                <label>Skills <span style="color:#4f46e5; font-size:10px;">(Focus on Technical Skills)</span></label>
                <div class="login-tag-container" onclick="document.getElementById('skillInput').focus()">
                    <div id="tagsList" style="display:contents"></div>
                    <input type="text" id="skillInput" list="skillOptionsList" class="login-input" 
                    style="border:none; padding:5px; width:150px;" 
                    placeholder="e.g. Python, SQL..." 
                    autocomplete="off" 
                    onchange="handleSkillInput(this)">
                    <datalist id="skillOptionsList"></datalist>
                </div>
                <small style="color:#666; margin-top:5px; display:block;">
                    <i class="fas fa-info-circle"></i> Tip: Avoid soft skills like 'Communication'. Enter tools & languages.
                </small>
            </div>
            <br>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-primary-login" id="predictBtn" onclick="analyzeProfile()">Update & Analyze</button>
                <button class="btn-secondary-login" onclick="closeProfileModal()">Cancel</button>
            </div>
        </div> 
    </div> 

    <div class="modal" id="resultModal"> 
        <div class="modal-box login-theme" style="text-align: center; border-top: 5px solid #4f46e5;"> 
            <div style="margin-bottom: 20px;"><i class="fas fa-graduation-cap" style="font-size: 50px; color: #4f46e5;"></i></div>
            <h3>Prediction Complete!</h3>
            <div id="predictionList" style="text-align: left; background: #f8f9fa; padding: 15px; border:1px solid #e1e1e1; border-radius: 8px; margin-bottom: 20px;"></div>
            <button class="btn-primary-login" onclick="document.getElementById('resultModal').style.display='none'">Got it!</button>
        </div> 
    </div>

    <div class="modal" id="passModal"> 
        <div class="modal-box login-theme" style="width:400px;"> 
            <h3>Change Password</h3> 
            <div class="login-input-group">
                <label>Current Password</label>
                <div class="password-wrapper">
                    <input type="password" id="oldPass" class="login-input">
                    <i class="fas fa-eye toggle-password" onclick="togglePassword('oldPass', this)"></i>
                </div>
            </div>
            <br>
            <div class="login-input-group">
                <label>New Password</label>
                <div class="password-wrapper">
                    <input type="password" id="newPass" class="login-input">
                    <i class="fas fa-eye toggle-password" onclick="togglePassword('newPass', this)"></i>
                </div>
            </div>
            <br>
            <button class="btn-primary-login" onclick="changePassword()">Update Password</button>
            <div style="text-align: center; margin-top: 10px;">
                <span style="cursor: pointer; color: #666; font-size: 12px;" onclick="closePassModal()">Cancel</span>
            </div>
        </div> 
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/'; 
        let DEGREE_MAP = {};
        let CERT_MAP = {};
        let SKILL_LIST = [];
        window.addEventListener('load', async function() {
            try {
                await loadConfig(); 
                await loadData(); 
            } catch(e) { console.error("Init Error:", e); }
        });

        //CONFIG & DROPDOWN LOGIC 
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                if(!res.ok) throw new Error("Config load failed");
                const config = await res.json();
                
                DEGREE_MAP = config.degree_map || {};
                CERT_MAP = config.cert_map || {};

                const degSel = document.getElementById('editDegree');
                if(degSel) {
                    degSel.innerHTML = "";
                    Object.keys(DEGREE_MAP).forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d; opt.innerText = d;
                        degSel.appendChild(opt);
                    });
                }
                const skillDL = document.getElementById('skillOptionsList');
                if(skillDL) {
                    skillDL.innerHTML = "";
                    SKILL_LIST.sort().forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        skillDL.appendChild(opt);
                    });
                }
                const yearSelect = document.getElementById('editYear');
                if(yearSelect && yearSelect.options.length === 0) {
                    for(let i = 2030; i >= 2010; i--) {
                        const opt = document.createElement('option');
                        opt.value = i; opt.innerText = i;
                        yearSelect.appendChild(opt);
                    }
                }
                updateSpecializations();
            } catch(e) { console.error("Using fallback config or error:", e); }
        }

        function updateSpecializations() {
            const degSel = document.getElementById('editDegree');
            const specSel = document.getElementById('editSpec');
            if(!degSel || !specSel) return;

            const degree = degSel.value;
            specSel.innerHTML = "";
            const specs = DEGREE_MAP[degree] || [];
            specs.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.innerText = s;
                specSel.appendChild(opt);
            });
            updateCertSuggestions();
        }

        function updateCertSuggestions() {
            const specSel = document.getElementById('editSpec');
            if(!specSel) return;
            const spec = specSel.value;
            
            const certDL = document.getElementById('certOptions');
            if(certDL) {
                certDL.innerHTML = "<option value='None'>"; 
                const relevantCerts = CERT_MAP[spec] || [];
                relevantCerts.forEach(c => {
                    if (typeof c === 'string' && c !== '[object Object]') {
                        const opt = document.createElement('option');
                        opt.value = c;
                        certDL.appendChild(opt);
                    }
                });
            }
        }

        // DATA LOADING
        async function loadData() {
            try {
                const res = await fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val || "-"; };
                
                if(document.getElementById('welcomeMsg')) document.getElementById('welcomeMsg').innerText = "Welcome Back, " + (data.name || "User");
                setTxt('dispName', data.name);
                setTxt('dispEmail', data.email);
                setTxt('dispDegree', data.degree);
                setTxt('dispSpec', data.specialization);
                setTxt('dispCgpa', data.cgpa);
                setTxt('dispYear', data.graduation_year);
                setTxt('dispCert', data.certifications);
                const internVal = data.internships;
                document.getElementById('dispIntern').innerText = (internVal === 1 || internVal === '1' || internVal === true) ? "Yes" : "No";
                document.getElementById('dispSkills').innerText = (Array.isArray(data.skills) && data.skills.length > 0) ? data.skills.join(', ') : "-";
                // Admin Link
                if (data.role === 'admin' && document.getElementById('adminLinkContainer')) {
                    document.getElementById('adminLinkContainer').innerHTML = `<a href="/admin" class="menu-item"><i class="fas fa-user-shield"></i> Admin Panel</a>`;
                }
                loadHistory(); 
                loadAllCharts();
            } catch(e) { console.error("Load Data Error:", e); }
        }

        // MODAL LOGIC & PREDICTION
        function openProfileModal() {
            document.getElementById('editName').value = document.getElementById('dispName').innerText;
            
            //Smart Dropdown Selection
            const currentDegree = document.getElementById('dispDegree').innerText;
            if(DEGREE_MAP[currentDegree]) document.getElementById('editDegree').value = currentDegree;
            updateSpecializations();
            
            const currentSpec = document.getElementById('dispSpec').innerText;
            const specSel = document.getElementById('editSpec');
    
            let specExists = false;
            for(let op of specSel.options) { if(op.value === currentSpec) specExists = true; }
            if(specExists) {
                specSel.value = currentSpec;
                updateCertSuggestions();
            }
  
            const curCert = document.getElementById('dispCert').innerText;
            document.getElementById('editCert').value = (curCert !== '-' && curCert) ? curCert : '';
            
            document.getElementById('editCgpa').value = parseFloat(document.getElementById('dispCgpa').innerText) || 8.0;
            
            const curYear = parseInt(document.getElementById('dispYear').innerText);
            if(!isNaN(curYear)) document.getElementById('editYear').value = curYear;
            
            const curIntern = document.getElementById('dispIntern').innerText;
            document.getElementById('editIntern').value = (curIntern === 'Yes') ? "1" : "0";

            const tagContainer = document.getElementById('tagsList');
            tagContainer.innerHTML = '';
            const existingSkills = document.getElementById('dispSkills').innerText;
            if(existingSkills && existingSkills !== '-') existingSkills.split(',').forEach(s => addTag(s.trim()));
            
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }

        function handleSkillInput(input) {
            const val = input.value.trim();
            if(val) { addTag(val); input.value = ''; input.focus(); }
        }
        function addTag(text) {
            const cleanText = text.trim();
            if (!cleanText) return;
            const currentTags = Array.from(document.querySelectorAll('.login-tag')).map(t => t.innerText.trim().toLowerCase());
            if (currentTags.includes(cleanText.toLowerCase())) {
                alert("Skill already added!"); return;
            }
            const container = document.getElementById('tagsList');
            const tag = document.createElement('div');
            tag.className = 'login-tag';
            tag.innerHTML = `${cleanText} <i class="fas fa-times" onclick="this.parentElement.remove()"></i>`;
            container.appendChild(tag);
        }
        function getTags() {
            return Array.from(document.querySelectorAll('.login-tag')).map(t => t.innerText.trim());
        }

        async function analyzeProfile() {
            const btn = document.getElementById('predictBtn');
            const originalText = btn.innerText;

            btn.innerText = "Analyzing...";
            btn.disabled = true;

            const data = {
                degree: document.getElementById('editDegree').value,
                specialization: document.getElementById('editSpec').value,
                cgpa: parseFloat(document.getElementById('editCgpa').value) || 0,
                graduation_year: parseInt(document.getElementById('editYear').value) || 2025,
                internships: document.getElementById('editIntern').value,
                certifications: document.getElementById('editCert').value || "None",
                skills: getTags()
            };

            try {
                const updateRes = await fetch('/api/update_profile', {
                    method: 'PUT',headers: {'Content-Type': 'application/json','Authorization': 'Bearer ' + token},
                    body: JSON.stringify(data)
                });
                if (!updateRes.ok) {
                    const err = await updateRes.json();
                    throw new Error(err.message || "Failed to update profile.");
                }
                const res = await fetch('/api/predict', {
                    method: 'POST',headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.message || "Prediction failed.");
                }
                const result = await res.json();
            
                let html = '';
                if(result.justification) {
                    html += `<div style="background-color:#eff6ff; border:1px solid #bfdbfe; color:#1e40af; padding:10px; border-radius:6px; font-size:13px; margin-bottom:15px;">
                        <i class="fas fa-lightbulb" style="color:#f59e0b; margin-right:5px;"></i>
                        <strong>Why this role?</strong> ${result.justification}
                    </div>`;
                }
                result.top_predictions.forEach((p, i) => {
                    html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:5px;">
                        <span style="font-size:14px; color:#333;"><strong>${i+1}.</strong> ${p.job_role}</span> 
                        <span style="background:#eef2ff; color:#4f46e5; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600;">${p.confidence}%</span>
                    </div>`;
                });
                document.getElementById('predictionList').innerHTML = html;
                closeProfileModal();
                document.getElementById('resultModal').style.display = 'flex';
                loadData();
                
            } catch(e) { 
                console.error("Analysis Error:", e)
                alert("Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // HISTORY & CHARTS
        async function loadHistory() {
            const list = document.getElementById('historyList');
            if(!list) return;
            try {
                const res = await fetch('/api/history', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                
                if(data.length > 0 && document.getElementById('latestResultContainer')) {
                    const latest = data[0];
                    let subPreds = '';
                    if(latest.top_predictions && latest.top_predictions.length > 1) {
                        subPreds = latest.top_predictions.slice(1).map(p => 
                            `<span style="margin-right:10px; font-size:12px; color:#666;">• ${p.job_role} (${p.confidence}%)</span>`
                        ).join('');
                    }
                    document.getElementById('latestResultContainer').innerHTML = `
                    <h3 style="color:#333; margin:0 0 5px 0;">${latest.prediction}</h3>
                    <p style="color:#4f46e5; font-weight:600; font-size:14px; margin:0;">${latest.confidence}% Confidence</p>
                    <div style="margin-top:5px;">${subPreds}</div>
                    `;
                } else if (document.getElementById('latestResultContainer')) {
                    document.getElementById('latestResultContainer').innerHTML = `<p style="color: #666; font-style: italic;">No predictions yet.</p>`;
                }

                if (data.length === 0) { list.innerHTML = '<p style="color:#666; font-size:13px;">No predictions yet.</p>'; return; }
                
                // Render List
                let html = '<ul style="list-style: none; padding: 0;">';
                data.forEach(item => {
                    let fbHtml = item.feedback ? 
                        `<div style="text-align:right; font-size:14px; color:#f59e0b;">${'★'.repeat(item.feedback)}</div>` : 
                        `<div style="text-align:right; margin-top:5px;">${[1,2,3,4,5].map(n => `<button class="star-btn" onclick="submitFeedback('${item._id}', ${n})">★</button>`).join('')}</div>`;
                    let otherPredsHtml = '';
                    if (item.top_predictions && item.top_predictions.length > 1) {
                        const others = item.top_predictions.slice(1).map(p => `${p.job_role} (${p.confidence}%)`).join(', ');
                        otherPredsHtml = `<div style="font-size:11px; color:#718096; margin-top:2px;"><i>Alternatives: ${others}</i></div>`;
                    }
                    html += `<li style="border-bottom: 1px solid #eee; padding: 15px 0;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <div style="font-weight:600; color:#333; font-size:15px;">${item.prediction} <span style="color:#4f46e5; font-size:13px;">(${item.confidence}%)</span></div>
                                    ${otherPredsHtml}<div style="font-size:11px; color:#999; margin-top:2px; ">${item.date}</div>
                                </div>
                            ${fbHtml}
                        </div>
                    </li>`;
                });
                list.innerHTML = html + '</ul>';
            } catch (err) { list.innerHTML = '<p style="color:red; font-size:13px;">Error loading history.</p>'; }
        }

        async function submitFeedback(id, rating) {
            try { await fetch('/api/feedback', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ prediction_id: id, rating: rating }) }); loadHistory(); } catch(e) {}
        }

        function loadAllCharts() { 
            loadTrends(); 
            loadDegreeStats(); 
            loadComparison(); 
        }
        
        async function loadTrends() { 
            const ctx = document.getElementById('trendsChart'); 
            if(!ctx) return;
            if(Chart.getChart("trendsChart")) Chart.getChart("trendsChart").destroy();
            try { 
                const res = await fetch('/api/stats/job_distribution', { headers: { 'Authorization': 'Bearer ' + token } }); 
                const data = await res.json(); 
                new Chart(ctx, { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Predictions', data: data.data, backgroundColor: '#4f46e5', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); 
            } catch (e) {} 
        }
        
        async function loadDegreeStats() { 
            const ctx = document.getElementById('degreeChart'); 
            if(!ctx) return;
            if(Chart.getChart("degreeChart")) Chart.getChart("degreeChart").destroy();
            try { 
                const res = await fetch('/api/stats/degree_job', { headers: { 'Authorization': 'Bearer ' + token } }); 
                const data = await res.json(); 
                new Chart(ctx, { type: 'doughnut', data: { labels: data.labels, datasets: [{ data: data.data, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#4299e1', '#ed64ae'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } } }); 
            } catch (e) {} 
        }
        
        async function loadComparison() { 
            const ctx = document.getElementById('comparisonChart'); 
            if(!ctx) return;
            if(Chart.getChart("comparisonChart")) Chart.getChart("comparisonChart").destroy();
            try { 
                const res = await fetch('/api/stats/comparison', { headers: { 'Authorization': 'Bearer ' + token } }); 
                const data = await res.json(); 
                new Chart(ctx, { type: 'bar', data: { labels: data.labels, datasets: [ { label: 'You', data: data.user_data, backgroundColor: '#4f46e5', borderRadius: 4 }, { label: 'Market Avg', data: data.market_data, backgroundColor: '#e5e7eb', borderRadius: 4 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); 
                const insightsDiv = document.getElementById('insightsContainer');
                if (insightsDiv && data.insights) {
                    insightsDiv.innerHTML = data.insights.map(t => `<div style="font-size:13px; color:#555; margin-bottom:6px;">${t}</div>`).join('');
                }
            } catch (e) {} 
        }

        // NAVIGATION & UTILS 
        function switchTab(name) { 
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); 
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active')); 
            document.getElementById('menu-'+name).classList.add('active'); 
            document.getElementById(name+'Section').classList.add('active'); 
        }

        function openPassModal() { document.getElementById('passModal').style.display = 'flex'; }
        function closePassModal() { document.getElementById('passModal').style.display = 'none'; document.getElementById('oldPass').value = ''; document.getElementById('newPass').value = ''; }
        function togglePassword(id, icon) { const i = document.getElementById(id); i.type = i.type==='password'?'text':'password'; icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash'); }
        
        async function changePassword() { 
            const oldPass = document.getElementById('oldPass').value, newPass = document.getElementById('newPass').value; 
            if(!oldPass || !newPass) { alert("Please fill both fields."); return; } 
            try { 
                const res = await fetch('/api/change_password', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ old_password: oldPass, new_password: newPass }) }); 
                const result = await res.json(); 
                alert(result.message); if(res.ok) closePassModal(); 
            } catch(e) { alert("Server error"); } 
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/'; }
    </script> 
</body> 
</html>